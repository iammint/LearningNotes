# JSæ¨¡å—åŒ–
> å°†ä»£ç æ‹†åˆ†æˆç‹¬ç«‹çš„å—ï¼Œç„¶åå†æŠŠè¿™äº›å—è¿æ¥èµ·æ¥ï¼Œå¯ä»¥é€šè¿‡æ¨¡å—æ¨¡å¼æ¥å®ç°ã€‚
> 
> å—çš„å†…éƒ¨æ•°æ®/å®ç°æ˜¯ç§æœ‰çš„ï¼Œåªæ˜¯å‘å¤–æš´éœ²ä¸€äº›æ¥å£ï¼Œä¸å…¶å®ƒæ¨¡å—é€šä¿¡

# è½¯ä»¶åŒ…packages
è½¯ä»¶åŒ…æ˜¯å¯ä»¥å¤åˆ¶å’Œå®‰è£…çš„ä¸€å¤§å—ä»£ç ã€‚å®ƒå¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ï¼Œè€Œä¸”åŒ…å«å…¶ä¾èµ–çš„å…¶ä»–è½¯ä»¶åŒ…çš„ä¿¡æ¯ã€‚

# 1. åŒ¿åé—­åŒ…
> å‡½æ•°æ˜¯JavaScriptå”¯ä¸€çš„Local Scope
```js
let Module = (function() {
    let _private = "safe now"
    let foo = function() {
        console.log(_private)
    }
    return {
        foo: foo
    }
})()
Module.foo()
console.log(Module._private) //undefined
//åœ¨åŒ¿åé—­åŒ…å¤–è®¿é—®ä¸åˆ°å±€éƒ¨å˜é‡
```

ğŸ‘‡ä»¥å½¢å‚çš„å½¢å¼å¼•å…¥ä¾èµ–
```js
let Module = (function($) {
    let _$body = $("body")
    let foo = function() {
        console.log(_$body)
    }
    return {
        foo: foo
    }
})(jQuery)
Module.foo()
//åˆ©ç”¨windowæš´éœ²å¯¹è±¡ï¼Œå°†$å’ŒjQueryæ·»åŠ ç»™äº†window
```

# 2. ä¸ºä»€ä¹ˆè¦æ¨¡å—åŒ–ï¼Ÿ
1. é¿å…å‘½åå†²çª
2. æ›´å¥½åœ°åˆ†ç¦»ï¼ŒæŒ‰éœ€åŠ è½½
3. æé«˜å¤ç”¨æ€§
4. æ–¹ä¾¿ç»´æŠ¤

## ç°å®ä¸­ç¼ºç‚¹
é¡µé¢å¼•å…¥åŠ è½½jsè¯·æ±‚è¿‡å¤šï¼Œä¾èµ–æ¨¡ç³Šï¼Œéš¾ä»¥ç»´æŠ¤

# 3. IIFEæ¨¡å¼
> Immediately Invoked Function Expression
![module.png](https://media.haochen.me/module.png)

 When you have an IIFE, it's treated as an expression and instantly executed. This means that any variables or scopes created within the IIFE are not accessible outside of it. But it also allows us to provide data from an outside scope and return scoped information. 

```js
//module.jsä¸­
let obj = {
    msg: "module",
    foo() {
        console.log("foo", this.msg)
    }
}

//htmlä¸­
obj.foo()//foo module

//ä¿®æ”¹msg
obj.msg = "module2"
obj.foo() //foo module2
```

åœ¨è¢«å¼•ç”¨çš„jsæ–‡ä»¶ä¸­ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°
```js
//module.jsä¸­
(function(window) {
    let msg = "module3"
    function foo() {
        console.log("foo", msg)
    }
    //æš´éœ²æ¥å£
    window.module3 = {
        foo: foo
    }
    //window.module3 = {foo}
})(window)
//htmlä¸­
//æ­¤æ—¶ä¸èƒ½ç›´æ¥åœ¨htmlä¸­ä¿®æ”¹msgï¼Œå› ä¸ºæ²¡æœ‰æ¥å£
module3.foo() //module3
```

```js
//module.jsä¸­
(function(window) {
    let msg = "module4"
    function foo() {
        console.log("foo", msg)
    }
    window.module4 = foo
})(window)

//htmlä¸­
//ç›´æ¥è°ƒç”¨
module4() //foo module4
```

 But lots of IIFE's are slow. Even you only use one function from a package, you still need to add the entire library. 

# 4. CommonJS
æ¯ä¸ªJSæ–‡ä»¶éƒ½å¯ä»¥å½“ä½œä¸€ä¸ªæ¨¡å—
- åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ¨¡å—çš„åŠ è½½æ˜¯è¿è¡Œæ—¶åŒæ­¥åŠ è½½çš„
- CommonJSæ¨¡å—è¯­æ³•ä¸èƒ½ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œã€‚å› æ­¤åœ¨æµè§ˆå™¨ç«¯ï¼Œæ¨¡å—éœ€è¦æå‰ç¼–è¯‘æ‰“åŒ…å¤„ç†


## 4.1 exports.xxx = value
1. module.exports = value
> æš´éœ²çš„æ˜¯exportså¯¹è±¡
2. exports.xxx = value
> æš´éœ²çš„æ˜¯æŒ‡å®šçš„æ–°å¯¹è±¡

exports æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºè¿™ä¸ªå¯¹è±¡èµ‹å€¼æ·»åŠ å±æ€§ï¼Œæ·»åŠ çš„å±æ€§ä¼šè¢«å¯¼å‡ºï¼š

```js
//åœ¨module.jsä¸­
const sayHello = () => {
    console.log("Hello!")
}
exports.sayHello = sayHello
```

commonJSæ¨¡å—çš„ä¸»è¦æ¦‚å¿µæ˜¯ä¸€ä¸ªåä¸ºrequireçš„å‡½æ•°ï¼Œå½“ä½ ä½¿ç”¨ä¾èµ–é¡¹çš„æ¨¡å—åè°ƒç”¨å®ƒæ—¶ï¼Œå®ƒä¼šç¡®ä¿åŠ è½½æ¨¡å—å¹¶è¿”å›æ¥å£ã€‚

å› ä¸ºåŠ è½½å™¨å°†æ¨¡å—ä»£ç åŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œæ‰€ä»¥æ¨¡å—ä¼šè‡ªåŠ¨è·å¾—å®ƒä»¬çš„å±€éƒ¨ä½œç”¨åŸŸã€‚å®ƒä»¬æ‰€è¦åšçš„å°±æ˜¯è°ƒç”¨requireæ¥è®¿é—®å®ƒä»¬çš„ä¾èµ–é¡¹å¹¶å°†å®ƒä»¬çš„æ¥å£æ”¾åœ¨ç»‘å®šåˆ°exportsçš„å¯¹è±¡ä¸­ã€‚

```js
//åœ¨test.jsæ–‡ä»¶ä¸­
let user = require('./module.js') //ç›¸å¯¹åœ°å€
user.sayHello() //Hello!
```
æ³¨æ„â—`let user = require('./module.js') `æœ¬è´¨æ˜¯ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œmodule.jså¹¶å°†è¯¥æ¨¡å—ä¸­çš„**exports**å¯¹è±¡èµ‹å€¼ç»™jsæ–‡ä»¶ä¸­çš„userå˜é‡ã€‚

|éªŒè¯ï¼š|
|:-:|
|åœ¨module.jsä¸­setTimeoutï¼Œå°†ä¿®æ”¹nameå±æ€§å€¼åŠ å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼›åŒæ—¶åœ¨test.jsä¸­ä¹ŸsetTimeoutï¼Œæ‰“å°nameï¼Œä¸globalä¸­çš„nameä¸ä¸€è‡´|


```js
//module.js
const name = "Mint"
const sayHello = () => {
    console.log("Hello!")
}
exports.name = name
exports.sayHello = sayHello
setTimeout(() => {
    exports.name = "Matt"
}, 0);
```

```js
//test.js
const foo = require("./test.js")
foo.sayHello()
console.log(foo.name)
setTimeout(() => {
    console.log(foo.name)
}, 0);
```


## 4.2 Module.exports
> module.exports å®é™…ä¸Šå°±æ˜¯å¯¹ exports çš„å¼•ç”¨ï¼Œæˆ‘ä»¬å¯¼å‡ºæœ€ç»ˆå…¶å®å¯¼å‡ºçš„æ˜¯ module.exportsï¼Œå®ƒæ˜¯ä¸ªå¯¹è±¡ã€‚

```js
//module.js
const name = "Mint"
const sayHello = () => {
    console.log("Hello!")
}
module.exports = {
    name: name,
    sayHello: sayHello
}
```

```js
//test.js
const foo = require("./test.js")
foo.sayHello() //Hello!
```
æœ€ç»ˆå¯¼å‡ºçš„æ˜¯ module.exportsï¼ŒåŸç†æ˜¯åœ¨module.js ä¸­æˆ‘ä»¬ä¸º module.exports èµ‹å€¼äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ­¤æ—¶ module.exports å°±ä¸å†æŒ‡å‘ exports äº†ï¼


## 4.3 æ¨¡å—çš„åŠ è½½é¡ºåºä¸æ‰§è¡Œ
### 1. åŠ è½½é¡ºåº
- å¦‚æœå½“å‰æ¨¡å—æ˜¯æ ¸å¿ƒæ¨¡å—ï¼Œä¾‹å¦‚ require('path')ï¼Œç›´æ¥è¿”å›å¯¹åº”çš„æ ¸å¿ƒæ¨¡å—ã€‚
- å¦‚æœæ˜¯ä¸€ä¸ªè·¯å¾„ï¼Œä¾‹å¦‚ require('./foo') æˆ–è€… require('./foo.js')ï¼š
    - å°è¯•å°† foo å½“æˆä¸€ä¸ªç¡®åˆ‡çš„æ–‡ä»¶åæ¥æŸ¥æ‰¾ã€‚
    - å¦‚æœæŒ‰ç¡®åˆ‡çš„æ–‡ä»¶åæ‰¾ä¸åˆ°æ¨¡å—ï¼Œåˆ™ Node.js ä¼šå°è¯•å¸¦ä¸Š .jsã€ .json æˆ– .node æ‰©å±•åå†åŠ è½½ï¼ŒæŸ¥æ‰¾å®Œæˆç›´æ¥è¿”å›ã€‚
    - å¦‚æœä¸Šè¿°æ­¥éª¤è¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œæˆ‘ä»¬å°†æŠŠ foo å½“æˆä¸€ä¸ªç›®å½•ï¼Œä¾æ¬¡æŸ¥æ‰¾å…¶ä¸‹çš„ index.jsã€index.jsonã€index.node æ–‡ä»¶
- å¦‚æœå®ƒä¸æ˜¯ä¸€ä¸ªè·¯å¾„ï¼ˆä¾‹å¦‚ä¸€äº›ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šä»å½“å‰ç›®å½•çš„ node_modules å¼€å§‹æœç´¢ã€ç›´åˆ°æ ¹ç›®å½•ã€‚

### 2. æ‰§è¡Œ
- æ¨¡å—åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œä¼šè¢«è‡ªä¸Šè€Œä¸‹æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¼šè¢«ç¼“å­˜ã€‚
- æ¨¡å—åœ¨ç¬¬äºŒæ¬¡åŠ è½½æ—¶ï¼Œä¸ä¼šå†è‡ªä¸Šè€Œä¸‹æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è·å–ç¼“å­˜çš„å†…å®¹ã€‚

## 4.4 CommonJSç¼ºç‚¹
CommonJS åŠ è½½æ¨¡å¼æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ç­‰åˆ° require çš„ç›®æ ‡æ¨¡å—åŠ è½½å®Œæ¯•ï¼Œæˆ‘ä»¬æ‰å¯ä»¥è¿è¡Œç›¸åº”çš„æ¨¡å—ï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨æµè§ˆå™¨ä¸Šä¸å¤ªå¥½ -- æˆ‘ä»¬éœ€è¦å°†å¯¹åº”çš„æ¨¡å—ä¸‹è½½ä¸‹æ¥ã€å†å¼€å§‹è¿è¡Œï¼Œä½“éªŒå¾ˆå·®ã€‚


# 5. ES modules
- æ”¯æŒå¼‚æ­¥Async
- 'import'
- 'export'

```js
//import all from utils.js 
import * as utils from './utils'
//only import the function first
import {first} from './utils'
```

//HTML
```js
<script type="module" src="./xxx.js"></script>
```

## 5.1 export
å¯¼å‡ºæ¨¡å—å¿…é¡»åœ¨æ¨¡å—é¡¶çº§ï¼Œä¸èƒ½åµŒå¥—åœ¨æŸä¸ªå—ä¸­ã€‚

1. å‘½åå¯¼å‡º
> export å…³é”®å­—å¯¼å‡ºä¸€ä¸ªæ¨¡å—ä¸­çš„å˜é‡ã€å‡½æ•°ã€ç±»ç­‰å¯¼å‡º
```js
//å‘½åè¡Œå†…å¯¼å‡º
export const name = 'Mint'

//å‘½åå­å¥å¯¼å‡º
const foo = 'foo'
export {foo}

//å¯¼å‡ºæ—¶ä¹Ÿå¯ä»¥æä¾›åˆ«åï¼Œä½†æ˜¯åˆ«åå¿…é¡»åœ¨exportå­è¯­å¥ä¸­çš„å¤§æ‹¬å·ä¸­æŒ‡å®š
export {foo as myFoo}

export function() {
    console.log("Hello!")
}

export class Foo{
    constructor() {

    }
}
```
2. é»˜è®¤å¯¼å‡º
```js
//module.js
const foo = 'foo'
export default foo

const foo = 'foo'
const bar = 'bar'
export {foo as default, bar}

//é’ˆå¯¹default exportçš„import
import foo from "./module.js"
```

3. æ‰¹é‡å¯¼å‡ºï¼ˆä¸è¦ä¸CommonJSæ··æ·†â—ï¼‰
```js
const sayBye = function() {
    console.log("Bye!")
}
class Foo {
    construcor() {

    }
}
export {
    sayBye,
    Foo
}
âŒ//ä»¥ä¸‹ä»£ç ä¸åˆæ³•ï¼Œexportåé¢ä¸æ˜¯å¯¹è±¡
eport {
    name: "Mint"
}
```


## 5.2 import
æ¨¡å—å¯ä»¥é€šè¿‡ä½¿ç”¨importå…³é”®å­—ä½¿ç”¨å…¶ä»–æ¨¡å—å¯¼å‡ºçš„å€¼ï¼Œimportä¹Ÿåªèƒ½å‡ºç°åœ¨æ¨¡å—çš„é¡¶çº§
```js
import {sayBye, Foo} from "./module.js"
sayBye() //Bye!
```
æ¨¡å—æ ‡è¯†ç¬¦å¯ä»¥æ˜¯ç›¸å¯¹äºå½“å‰æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æŒ‡å‘æ¨¡å—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œå¿…é¡»æ˜¯çº¯å­—ç¬¦ä¸²ã€‚

å‘½åå¯¼å‡ºå’Œé»˜è®¤å¯¼å‡ºçš„åŒºåˆ«ä¹Ÿä½¿å¯¼å…¥ä¸åŒã€‚

1. å¯¼å…¥å‘½åå¯¼å‡ºçš„é›†åˆ
> å‘½åå¯¼å‡ºå¯ä»¥ä½¿ç”¨*æ‰¹é‡è·å–å¹¶èµ‹å€¼ç»™ä¿å­˜å¯¼å‡ºé›†åˆçš„åˆ«å
> 
>  æŒ‡åå¯¼å…¥éœ€è¦å°†æ ‡è¯†ç¬¦æ”¾åœ¨importå­å¥ä¸­
```js
const foo = "foo", bar = "bar", baz = "baz"
export{foo, bar, baz}

import * as Foo from './foo.js'
console.log(Foo.foo) //foo

import{foo, bar, baz as myBaz} from './foo.js'

```
2. é»˜è®¤å¯¼å‡ºçš„é›†åˆå¯ä»¥ä½¿ç”¨defaultå…³é”®å­—å¹¶æä¾›åˆ«åæ¥å¯¼å…¥
```js
import {default as foo} from "./foo.js"
```

## 5.3 importå’Œexportæ··ç”¨
å¦‚æœä½ å¼€å‘ä¸€ä¸ªåº“ï¼Œé‚£ä¹ˆä½ æœ‰å¿…è¦æš´éœ²ä¸€äº›æ¥å£åˆ°**åº“å…¥å£**ä¸­ï¼Œæ–¹ä¾¿ç”¨æˆ·è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š
```js
import bar from "./modules.js"
import foo from "./foo.js"
export {
    band,
    baz
}
```
å¦‚æœ import å¾ˆå¤šï¼Œä»£ç ä¸å¤ªå¥½çœ‹ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥å°† import å’Œ export æ··ç”¨ï¼Œåƒè¿™æ ·ï¼š
```js
export bar from "./modules.js"
export foo from "./foo.js"
export {
    band,
    baz
}
//ç­‰ä»·äºä¸Šæ–¹ä»£ç 
```

## 5.4 ES Module ç‰¹ç‚¹
1. å’Œ CommonJS ä¸åŒï¼ŒES Module å¤„ç†ä¾èµ–å…³ç³»çš„æ—¶æœºä¸æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œè€Œæ˜¯**åœ¨è§£ææ—¶**ï¼ˆè¿™ç§è¡Œä¸ºå¯ä»¥ç§°ä¸º**é™æ€è§£æ**ï¼‰ã€‚
   1. è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æˆ‘ä»¬æåˆ° `import `ä¸å¯ä»¥ç›´æ¥åœ¨ä»£ç å—ä¸­åµŒå…¥ã€‚
   2. è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ`import`è¯­å¥ä¸å¯ä»¥æºå¸¦å˜é‡ï¼Œè€Œ`require`è¯­å¥å¯ä»¥ï¼Œå› ä¸º require è¯­å¥æ˜¯è¾¹æ‰§è¡Œè¾¹å¤„ç†ä¾èµ–å…³ç³»ã€‚
2. å¼‚æ­¥é€’å½’åŠ è½½è§£æ
    æ‰€æœ‰çš„æ¨¡å—éƒ½æ˜¯å¼‚æ­¥é€’å½’åŠ è½½è§£æçš„ï¼Œç±»ä¼¼äºæ·»åŠ  < script defer > çš„è„šæœ¬ï¼Œè¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å¼¥è¡¥ CommonJS çš„åŒæ­¥åŠ è½½æœºåˆ¶åœ¨æµè§ˆå™¨ç¯å¢ƒçš„å¼Šç«¯ã€‚


### ä¸è¦ä½¿ç”¨**export default**
åœ¨ TypeScript ç¯å¢ƒä¸‹ï¼Œå°è¯•å°†ä»¥ä¸‹ä»£ç ç¼–è¯‘æˆ CommonJSï¼š
```js
const a = 1
export default a
```
è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```js
Object.defineProperty(exports, "__esModule", { value: true });
const a = 1;
exports.default = a;
```
å½“æˆ‘ä»¬è¦è·å–aæ—¶éœ€è¦å¦‚ä¸‹ä»£ç ï¼š
```js
const project = require('project').default
console.log(project);
```

å¯ä»¥çœ‹å‡ºå¤šäº†ä¸€ä¸ª **default å±æ€§**æ‰èƒ½æ‹¿åˆ°é»˜è®¤å¯¼å‡ºï¼Œè¿™å¯¹è°ƒç”¨è€…ä¸å¤ªå‹å¥½ï¼ˆæˆ‘ä»¬ä¹ æƒ¯ç›´æ¥ requireï¼‰ã€è€Œä¸”è°ƒç”¨è€…ä¸€æ–¹çš„ä»£ç ä¹Ÿä¸å¥½çœ‹ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬å°½é‡é¿å…ä½¿ç”¨ `export default`ã€‚


## 5.5 ES Moduleçš„å·¥ä½œæœºåˆ¶
1. æ„å»ºé˜¶æ®µ

    æ„å»ºé˜¶æ®µå°±æ˜¯æµè§ˆå™¨å°è¯•**ä¸‹è½½ã€è§£æ**æ‰€æœ‰éœ€è¦çš„æ¨¡å—æ–‡ä»¶ï¼Œå¹¶å½¢æˆ**æ¨¡å—è®°å½•**çš„è¿‡ç¨‹ã€‚
    1. æµè§ˆå™¨ä¼šè§£æå…¥å£æ¨¡å—ï¼Œç¡®å®šä¾èµ–ï¼Œå¹¶å‘é€å¯¹ä¾èµ–æ¨¡å—çš„è¯·æ±‚ã€‚è¿™äº›æ–‡ä»¶é€šè¿‡ç½‘ç»œè¿”å›åï¼Œæµè§ˆå™¨å°±ä¼šè§£æå®ƒä»¬çš„å†…å®¹ã€ç¡®å®šå®ƒä»¬çš„ä¾èµ–
    ```js
    <script src="./modules.js" type="module"></script>
    ```
    2. å¦‚æœè¿™äº›å…¥å£è„šæœ¬çš„ä¾èµ–è¿˜æœªåŠ è½½åˆ™ä¼šå‘é€æ›´å¤šè¯·æ±‚ã€‚è¿™ä¸ªå¼‚æ­¥é€’å½’åŠ è½½è¿‡ç¨‹ä¼šæŒç»­åˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ä¾èµ–å›¾éƒ½è§£æå®Œæˆã€‚
    3. ä¸Šé¢çš„æ¯ä¸ªæ¨¡å—åŠ è½½å®Œæˆä¹‹åï¼Œéƒ½ä¼šåˆ›å»ºç›¸åº”çš„**æ¨¡å—è®°å½•**ï¼ŒåŒæ—¶æµè§ˆå™¨è¿˜ä¼šç»´æŠ¤ä¸€å¼ æ¨¡å—æ˜ å°„è¡¨ï¼Œå®ƒä¿å­˜äº†**æ¨¡å—è·¯å¾„ -- æ¨¡å—è®°å½•**çš„æ˜ å°„å…³ç³»ã€‚

2. å®ä¾‹åŒ–é˜¶æ®µ

    åœ¨å®ä¾‹åŒ–é˜¶æ®µï¼Œ**ä»£ç å’Œå†…å­˜**å°†å»ºç«‹èµ·å…³ç³»

    1. é¦–å…ˆï¼ŒJS å¼•æ“åˆ›å»ºä¸€ä¸ª**æ¨¡å—ç¯å¢ƒè®°å½•**ï¼ˆmodule environment recordï¼‰ï¼Œå®ƒç®¡ç†æ¨¡å—è®°å½•ä¸­çš„å˜é‡ã€‚
    2. ä¸º**æ¯ä¸€ä¸ªexport** åœ¨å†…å­˜ä¸­å¼€è¾Ÿç›¸åº”çš„ç©ºé—´ï¼Œç›¸åº”çš„æ¨¡å—ç¯å¢ƒè®°å½•ä¹Ÿä¼šæŒ‡å‘è¿™äº›å†…å­˜ç©ºé—´ï¼Œç°åœ¨è¿™äº›å†…å­˜ç©ºé—´å¹¶æ²¡æœ‰è¢«å¡«å……å€¼ï¼Œèµ‹å€¼æ“ä½œå°†åœ¨æ‰§è¡Œé˜¶æ®µå‘ç”Ÿã€‚

        ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰æ‰«æåˆ° export è¯­å¥ï¼Œç›¸åº”çš„å˜é‡æ‰ä¼šè¢«å†™å…¥åˆ°å¯¼å‡ºå†…å­˜ä¸­ã€‚

    3. å¼•æ“åœ¨åˆ†æå®Œæ¨¡å—æ‰€æœ‰çš„å¯¼å‡ºä¹‹åï¼Œå¼€å§‹å¤„ç†æ¨¡å—çš„å¯¼å…¥ï¼Œ**å¯¼å…¥å’Œå¯¼å‡ºéƒ½æŒ‡å‘å†…å­˜ä¸­ç›¸åŒçš„ä½ç½®**ã€‚

3. æ‰§è¡Œé˜¶æ®µ

    æœ€åä¸€æ­¥æ˜¯æ‰§è¡Œé˜¶æ®µï¼ŒJS å¼•æ“å°†å˜é‡å¡«å……åˆ°å¯¹åº”çš„å†…å­˜ç©ºé—´ä¸­ï¼Œç„¶åä»å…¥å£æ–‡ä»¶å¼€å§‹ï¼Œæ‰§è¡Œç”¨æˆ·çš„ä»£ç ã€‚


## 5.6 å¾ªç¯ä¾èµ–ç‰¹æ€§

### 1. å¯¹äºCommonJS
```js
//index.js
let count = require("./counter.js")
console.log(count)
exports.message = "hello world!"


//counter.js
let message = require("./index.js").message
exports.count = 5
setTimeout(() => {
    console.log(message)
}, 0)
```
1. å…ˆåŠ è½½`index.js`æ‰§è¡Œç¬¬ä¸€è¡Œï¼Œè¿›å…¥`counter.js`
2. æ‰§è¡Œ`counter.js`çš„ç¬¬ä¸€è¡Œï¼Œå¾ªç¯ä¾èµ–`index.js`
3. ç”±äº`index.js`æ²¡æœ‰åŠ è½½å®Œæˆï¼Œmessageçš„å€¼ä¸ºundefined
4. `counter.js`å¯¼å‡ºäº†countå˜é‡
5. å›åˆ°`index.js`æ‰“å°countçš„å€¼5
6. å¯¼å‡ºmessageå˜é‡ï¼Œæ­¤æ—¶ä¸èµ·ä½œç”¨ï¼Œå› ä¸º`counter.js`çš„messageå·²ç»è¢«è§£ææˆundefined
7. æ‰§è¡Œ`setTimeout()`ä¸­çš„ä»»åŠ¡ï¼Œæ‰“å°`counter.js`çš„message *undefined*

### 2. å¯¹äºESModule
```js
// index.js
import { count } from './counter.js'
const message = '666'
console.log(count)
export {
  message
}

// counter.js
import { message } from './index.js'
const count = 5
setTimeout(() => {
  console.log(message)
}, 0)
export {
  count
}
```
1. JS å¼•æ“è§£ææ¨¡å—ï¼Œåˆ†æ `import` å’Œ `export`ï¼Œè¿›è¡Œè¿æ¥ï¼Œæ­¤æ—¶å­˜æ”¾å¯¼å‡ºå€¼çš„å†…å­˜ï¼ˆä¸‹é¢ç®€ç§°ä¸ºå¯¼å‡ºå†…å­˜ï¼‰ä¸­è¿˜æ²¡æœ‰è¢«å¡«å……å€¼ã€‚
2. è¿›å…¥æ‰§è¡Œé˜¶æ®µï¼Œå…ˆæ‰§è¡Œ`index.js`ï¼Œç”±äºJSå¼•æ“å·²ç»å¯¹`import` å’Œ `export`è¿›è¡Œè¿‡åˆ†æï¼Œå› æ­¤ç›´æ¥è¿›å…¥ç¬¬äºŒè¡Œindexçš„<font color=red>message</font>è¢«èµ‹å€¼666ï¼Œç°åœ¨å®ƒä½œä¸ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œ<font color=red>å¹¶æœª</font>è¢«å†™å…¥åˆ°å¯¼å‡ºå†…å­˜ä¸­ã€‚
3. `index.js`æ‰§è¡Œè‡³ç¬¬ä¸‰è¡Œæ—¶éœ€è¦å¯¼å…¥countå˜é‡ï¼Œå®ƒæ‰§è¡Œå¯¼å‡ºå†…å­˜çš„ count éƒ¨åˆ†ï¼Œç”±äºæ­¤æ—¶ count æ²¡æœ‰è¢«å¡«å……ï¼Œæˆ‘ä»¬è‡ªä¸Šè€Œä¸‹æ‰§è¡Œ`counter.js`
4. åœ¨`counter.js`æ‰§è¡Œåˆ°exportè¯­å¥æ—¶ï¼Œå†…å­˜ä¸­çš„ count è¢«å¡«å……ä¸º 5ï¼Œ`counter.js `ç»§ç»­æ‰§è¡Œ`setTimeout()`, `console.log(message)` è¢«åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚
5. `index.js`æ‰“å°countï¼Œå€¼ä¸º5ï¼Œæ¥ç€æ‰§è¡Œ`export`ï¼Œå°†messageå†™å…¥å¯¼å‡ºå†…å­˜ä¸­ã€‚
6. ä¸»çº¿ç¨‹ä»£ç ç»“æŸï¼Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ `console.log(message)`ï¼Œè¿™ä¸ª `message` æ˜¯ä» `index.js` å¯¼å…¥çš„ï¼Œå®ƒçš„å€¼å°±æ˜¯ 666ã€‚


## 5.7 exports ä¸ export çš„åŒºåˆ«

### 1. CommonJS exports
```js
// main.js
const foo = require('./foo.js')
console.log(foo.name)
setTimeout(() => {
  console.log(foo.name)
}, 1000)

// foo.js
let name = 'Mint'
setTimeout(() => {
  name = 'mint'
}, 0)
module.exports = {
  name
}
//exports.name = name 
```
æ‰§è¡Œ`main.js`è·å–fooï¼Œè¿›å…¥foo.jså¼€å§‹æ‰§è¡Œï¼Œè·å–åˆ°`name`ã€‚è¿”å›è‡³`main.js`æ‰“å°`foo.name`ã€‚

ç”±äºå¯¼å‡ºçš„æ˜¯`module.exports`çš„å¼•ç”¨ï¼Œæ”¹å˜nameï¼Œåˆå› ä¸ºnameæ˜¯ä¸€ä¸ªåŸå§‹å€¼è€Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œå’Œå¯¼å‡ºçš„`module.exports`å¯¹è±¡çš„nameå±æ€§å¹¶ä¸ç›¸åŒï¼Œæ‰€ä»¥nameçš„å€¼å¹¶ä¸ä¼šæ”¹å˜ã€‚

### 2. ESModule export
```js
// main.js
import {name} from './foo.js'
console.log(name)
setTimeout(() => {
  console.log(name)
}, 1000)

// foo.js
let name = 'Mint'
setTimeout(() => {
  name = 'mint'
}, 0)
export {
  name
}
```
é¦–å…ˆå¯¹`export`ä¸`import`è¿›è¡Œåˆ†æï¼Œæ¥ç€è¿›å…¥`main.js`æ‰§è¡Œ`console.log(name)`ï¼Œå› æ­¤éœ€è¦è¿›å…¥foo.jsä¸­è·å–nameï¼Œ`export{ name }`æ­¤æ—¶å€¼ä¸º"Mint"ï¼Œæ›´æ”¹`name`å˜é‡çš„è¯­å¥è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ã€‚è·å¾—`name`åè¿”å›`main.js`ï¼Œæ‰“å°"Mint"ï¼Œæ‰“å°`name`çš„è¯­å¥åœ¨1000msæ—¶æ‰è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ã€‚

æ­¤æ—¶call stackæ¸…ç©ºï¼Œæ›´æ”¹`name`å˜é‡çš„è¯­å¥å…¥æ ˆå¼€å§‹æ‰§è¡Œï¼Œ**ç”±äºæœ¬è´¨ä¸Šexport ç«¯å’Œ import ç«¯æŒ‡å‘å†…å­˜ä¸­çš„ç›¸åŒä½ç½®**ï¼Œæ‰€ä»¥ä¿®æ”¹åå¯ä»¥è¢«æˆåŠŸå¯¼å‡ºï¼Œåœ¨1000msæ—¶å®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼Œæ‰“å°`name`ï¼Œæ­¤æ—¶ä¸º"mint"

### 3. ä¸ºä»€ä¹ˆ ESModule å¯ä»¥è·Ÿè¸ªä¿®æ”¹ï¼Ÿ
è¿™ä¸ªæœºåˆ¶å«å®æ—¶ç»‘å®šï¼ˆlive bindingï¼‰ï¼Œæœ¬è´¨ä¸Šæ˜¯export ç«¯å’Œ import ç«¯æŒ‡å‘å†…å­˜ä¸­çš„ç›¸åŒä½ç½®ï¼Œå’Œ CommonJS å¯¼å‡º module.exports å¯¹è±¡çš„æœºåˆ¶æ˜¯ä¸åŒçš„ã€‚


# 6. æ¨¡å—åŒ–å®è·µ
1. å°½å¯èƒ½ä½¿ç”¨ESModule

    - ESModuleæ˜¯å®˜ç½‘çš„æ¨¡å—åŒ–æ ‡å‡†ï¼Œå¯ä»¥å¾—åˆ°åŸç”Ÿæ”¯æŒ
    - æœ‰åˆ©äºæ‰“åŒ…å·¥å…·çš„TreeShaking
    - ESModuleçš„å‘ä¸‹å…¼å®¹å·¥å…·ç”Ÿæ€å¾ˆå¥½

2. ä½¿ç”¨CommonJSå…œåº•ï¼Œä¹Ÿå°±æ˜¯è¯´`package.json`çš„å…¥å£å¿…é¡»æ˜¯ä¸€ä¸ªCommonJSé¡¹ç›®ã€‚
3. ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„é¡¹ç›®è¿˜æ˜¯ç”¨ ESModule å†™ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å·¥å…·æŠŠå®ƒè½¬æ¢æˆ CommonJSã€‚

## 6.1 package.jsonçš„ä¸€äº›å­—æ®µ
> ä»¥çŸ¥åçš„å¼€æºé¡¹ç›®G2ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹package.jsonçš„ä¸€äº›å­—æ®µï¼š

![Snipaste_2022-07-08_10-54-49.png](https://media.haochen.me/Snipaste_2022-07-08_10-54-49.png)

1. ç¬¬ä¸€ä¸ªæ˜¯ main å­—æ®µï¼Œè¡¨ç¤º Node.js é»˜è®¤è¯†åˆ«é¡¹ç›®çš„å…¥å£ï¼ˆlibï¼‰ï¼Œå®ƒä»¥ CommonJS å…œåº•ï¼Œä¸€èˆ¬åœ¨æœåŠ¡ç«¯è°ƒç”¨ã€‚
2. ç¬¬äºŒä¸ªæ˜¯ module å­—æ®µï¼Œè¿™ä¸ªå­—æ®µ Node.js ä¸ä¼šç›´æ¥è¯†åˆ«ï¼Œæ‰“åŒ…å·¥å…·å¯ä»¥è¯†åˆ«ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªå­—æ®µï¼Œæ‰“åŒ…å·¥å…·ä¸ä¼šå»æ‰¾ CommonJS çš„ä»£ç è€Œä¼šä¼˜å…ˆå»æ‰¾ ESModule å…¥å£ï¼Œè¿™æ · TreeShaking å°±å¯ä»¥èµ·åˆ°ä½œç”¨ã€‚
3. ç¬¬ä¸‰ä¸ªæ˜¯ unpkg å­—æ®µï¼ˆä¹Ÿæœ‰ browser å­—æ®µï¼ŒåŠŸèƒ½ç±»ä¼¼ï¼Œä½†ä¸è¦ç”¨ï¼‰ï¼Œåœ¨æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ã€‚


### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ browser å­—æ®µï¼Ÿ
webpacké»˜è®¤ä¼˜å…ˆè¯†åˆ«` browser` ä¹Ÿå°±æ˜¯ `umd` è§„èŒƒï¼Œè¿™å°±ä½¿å¾—ä½ åªè¦ä½¿ç”¨äº†è¯¥åº“ä»»ä½•åŠŸèƒ½éƒ½ä¼šè¢«æ•´ä¸ªåº“æ‰“åŒ…è¿›æ¥ï¼Œè¿™æ ·ä½“ç§¯ä¼šå¾ˆå¤§ï¼Œäºæ˜¯ G2 ä½¿ç”¨äº† `unpkg` è¿™ä¸ªå­—æ®µæ¥ä»£æ›¿ `brower` ï¼Œä¸ä»…æ»¡è¶³äº†ä¸€äº›å¼€å‘è€…çš„éœ€æ±‚ï¼Œä¹Ÿæ»¡è¶³äº†è®© webpack é»˜è®¤è¯†åˆ« `module` ä»¥ä¾¿å®æ–½ TreeShaking çš„ç›®æ ‡ã€‚


# æ€»ç»“

å—çš„å†…éƒ¨æ•°æ®/å®ç°æ˜¯ç§æœ‰çš„ï¼Œåªæ˜¯å‘å¤–æš´éœ²ä¸€äº›æ¥å£ï¼Œä¸å…¶å®ƒæ¨¡å—é€šä¿¡ï¼ŒJavaScriptæš´éœ²å—æ¥å£çš„æ–¹å¼æœ‰ä»¥ä¸‹æ¼”å˜ï¼š
1. åœ¨åŒ¿åé—­åŒ…å¤–è®¿é—®ä¸åˆ°å±€éƒ¨å˜é‡ï¼Œä»¥å½¢å‚çš„å½¢å¼å¼•å…¥ä¾èµ–
2. IIFEæ¨¡å¼ï¼šç«‹å³æ‰§è¡Œå‡½æ•°ä»¥å½¢å‚å½¢å¼æš´éœ²æ¥å£
3. CommonJSï¼šexports æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºè¿™ä¸ªå¯¹è±¡èµ‹å€¼æ·»åŠ å±æ€§ï¼Œæ·»åŠ çš„å±æ€§ä¼šè¢«å¯¼å‡ºã€‚

    ç¼ºç‚¹ï¼šNo browser support, no living bindings, slow for the synchronous case.

4. ESModuleï¼šå¼‚æ­¥è§£æåŠ è½½

    ç¼ºç‚¹ï¼šToo slow! The browser has to basically read top down to resolve `import` when you load your page. 

æœ¬æ–‡ä»‹ç»äº† CommonJS å’Œ ESModule çš„åŸç†å’Œç‰¹æ€§ï¼ŒCommonJS é€šè¿‡ `require`ã€`module.exports` / `exports`ï¼Œå®ç°æ¨¡å—çš„å¯¼å…¥å’Œå¯¼å‡ºï¼ŒCommonJS çš„ç‰¹ç‚¹æ˜¯åŒæ­¥è§£æåŒæ­¥åŠ è½½ï¼Œè¿™ç§ç‰¹ç‚¹åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹æœ‰å¤©ç”Ÿçš„åŠ£åŠ¿ã€‚

ECMAScript 6 è§„èŒƒé‡æ–°å®šä¹‰äº†æµè§ˆå™¨æ¨¡å—ï¼Œè¯­æ³•æ›´åŠ å‹å¥½ï¼Œé€šè¿‡ `import`ã€`export` è¯­æ³•æ¥å®ç°æ¨¡å—çš„å¯¼å…¥å¯¼å‡ºï¼Œå®ƒçš„ç‰¹ç‚¹å’Œ CommonJS ä¸åŒï¼Œæµç¨‹ä¸»è¦åˆ†ä¸º**æ„å»ºé˜¶æ®µ**ï¼ˆå¼‚æ­¥ä¸‹è½½æ¨¡å—ï¼‰ã€**å®ä¾‹åŒ–é˜¶æ®µ**ï¼ˆä¸ºæ¯ä¸ª export å¼€è¾Ÿç›¸åº”çš„å†…å­˜ï¼‰ã€**æ‰§è¡Œé˜¶æ®µ**ï¼ˆæ‰§è¡Œè„šæœ¬ã€å°†å¯¼å‡ºå¯¹åº”çš„å†…å­˜åŒºåŸŸå¡«å……å€¼ã€å°†å¯¼å…¥è¿æ¥åˆ°å¯¹åº”çš„å¯¼å‡ºå†…å­˜åŒºåŸŸï¼‰ï¼Œç›¸æ¯”äºååˆ†çµæ´»çš„ CommonJSï¼ŒESModule çš„è¯­æ³•ç‰¹æ€§ä¹Ÿä½¿å¾—**é™æ€åˆ†æ**æ›´åŠ æ–¹ä¾¿ï¼Œä½¿ **TreeShaking** çš„å®ç°æ›´åŠ æ–¹ä¾¿ã€‚

åœ¨å®é™…å¼€å‘ç¬¬ä¸‰æ–¹åº“æ—¶ï¼ŒESModule ä½œä¸ºæ ‡å‡†åŒ–çš„æ¨¡å—æ–¹æ¡ˆã€æœªæ¥çš„è¶‹åŠ¿ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½ä½¿ç”¨å®ƒï¼Œå½“ç„¶ä¸ºäº†**å‘ä¸‹å…¼å®¹**ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†å…¶æ„å»ºæˆ **CommonJS** ä½œä¸ºæ¨¡å—çš„é»˜è®¤å‡ºå£ï¼Œä¸ºäº†åˆ©ç”¨æ‰“åŒ…å·¥å…·çš„ **TreeShaking**ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `package.json` é…ç½® `module`å­—æ®µæŒ‡å‘ ESModule çš„ç‰ˆæœ¬ä»¥å‘ŠçŸ¥æ‰“åŒ…å·¥å…·ä½œå‡ºæ€§èƒ½ä¼˜åŒ–ã€‚


# 7. Dive into Module
## 1. What problem do modules solve?

For the existence of scopes in JavaScript, functions can't access variables that are defined in other functions. What if you do want to share your variable outside of a scope? 

A common way to handle this is to put it on a scope above you. 

1. It makes removing old code or script tags a game of roulette.

2. Malicious code can change that variable on purpose to make your code do something you didnâ€™t mean for it to.

## 2. How do modules help?
Modules put functions and variables into a module scope. Unlike function scopes, module scopes have a way of making their variables available to other modules as well which is `export`. They can say explicitly which of the variables, classes, or functions in the module should be available. 

![Snipaste_2022-07-09_11-51-14.png](https://media.haochen.me/Snipaste_2022-07-09_11-51-14.png)

## 3. How ES modules work

You build up a graph of dependencies by using`import`. 

![Snipaste_2022-07-09_11-55-48.png](https://media.haochen.me/Snipaste_2022-07-09_11-55-48.png)

1. æ„å»ºé˜¶æ®µ**Construction**

But files themselves arenâ€™t something that the browser can use. It needs to parse all of these files to turn them into data structures called **Module Records**. That way, it actually knows whatâ€™s going on in the file.

![Snipaste_2022-07-09_11-58-48.png](https://media.haochen.me/Snipaste_2022-07-09_11-58-48.png)

2. å®ä¾‹åŒ–é˜¶æ®µ**Instantiation**

After that, the module record needs to be turned into a **module instance**. An instance combines two things: **the code and state**.

![Snipaste_2022-07-09_12-19-05.png](https://media.haochen.me/Snipaste_2022-07-09_12-19-05.png)

- The code is basically a set of instructions.
- State is the actual values of the variables at any point in time.


Find boxes in memory to place all of the exported values in (but donâ€™t fill them in with values yet). Then make both exports and imports point to those boxes in memory. This is called linking.

3. æ‰§è¡Œé˜¶æ®µ**Evaluation**

Run the code to fill in the boxes with the variablesâ€™ actual values.

![Snipaste_2022-07-09_12-24-59.png](https://media.haochen.me/Snipaste_2022-07-09_12-24-59.png)



![Snipaste_2022-07-09_12-38-29.png](https://media.haochen.me/Snipaste_2022-07-09_12-38-29.png)



### Asychronicity
ES Modules can be either asynchronous or synchronous. Thatâ€™s because not everything is controlled by the ES module spec.

 There are actually two halves of the work, which are covered by different specs.

 The ES module spec says how you should parse files into module records, and how you should instantiate and evaluate that module. However, it doesnâ€™t say how to get the files in the first place.

It's the loader that fetches the files. And the loader is specified in a different specification. For browsers, that spec is the HTML spec. 

![Snipaste_2022-07-09_13-34-07.png](https://media.haochen.me/Snipaste_2022-07-09_13-34-07.png)


## 4. Different phases in more detail
### 1. Construction
1. Figure out where to download the file containing the module from.
    
   Find the entry point file from the module specifier which sometimes needs to be handled differently between browsers and Node through module resolution algorithm. 
   
   We have to go through the tree layer-by-layer, parsing one file, then figuring out its dependencies, and then finding and loading those dependencies. This is one of the reasons that the ES Module spec splits the algorithm into multiple phases. 

   CommonJS do things differently because loading files from the filesystem takes less time than downloading across the Internet. This means Node can block the main thread while it loads the file. You are executing all of the code in this module before you look for the next module. But with ES Modules, you're building up this whole module graph beforehand. 


2. Fetch the file
3. Parse the file into a module record.
        
    Now that we have fetched this file, we need to parse it into module record. Once the module record is created, it is placed in the module map. This means that whenever itâ€™s requested from here on out, the loader can pull it from that map.

![Snipaste_2022-07-09_14-25-36.png](https://media.haochen.me/Snipaste_2022-07-09_14-25-36.png)

You need to put `type="module"`on the script tag. This tells the browser that this file should be parsed as a module and that any imports are modules, too.


### 2. Instantiation
The instantiation step is all about wiring things up to memory.

1. The JS engine creates a module environment record which manages the variables for the module record.
2. It finds boxes in memory for all of the exports. The module environment record will keep track of which box in memory is associated with each export.

    There is one caveat to this rule: any exported function declarations are initialized during this phase. This makes things easier for evaluation.

3. To instantiate the module graph, the engine will do what's called a depth first post-order traversal. This means it will go down to  the bottom of the graph â€” to the dependencies at the bottom that don't depend on anything else â€” and set up their exports.
   
4. The engine finishes wiring up all of the exports below a module. 


### 3. Evaluation
The final step is filling in these boxes in memory. The module map caches the module by URL so that there is only one module record for each module which can aviod side effects. 


